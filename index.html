<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>OCR + Keyword Extractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Puter SDK v2 -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --shadow:0 10px 30px rgba(0,0,0,.08);
      --btn:#111827; --btn2:#ffffff;
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:28px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{max-width:1200px;margin:0 auto 18px auto}
    h1{margin:0 0 6px 0;text-align:center;font-size:34px;letter-spacing:.2px}
    .sub{margin:0;text-align:center;color:var(--muted)}
    .container{
      max-width:1200px;margin:18px auto 0 auto;
      display:grid; grid-template-columns: 1fr 1fr; gap:22px;
    }
    @media (max-width: 980px){ .container{grid-template-columns:1fr} }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:18px; box-shadow:var(--shadow);
    }
    .card h2{margin:2px 0 12px 0;font-size:20px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    input[type="file"]{
      padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; background:#fff; flex:1;
    }

    .preview{
      margin-top:12px;
      border:1px dashed var(--border);
      border-radius:14px;
      padding:12px;
      min-height:260px;
      display:flex; align-items:center; justify-content:center;
      background:#fafafa;
      overflow:hidden;
    }
    .preview img{
      max-width:100%;
      max-height:520px;
      border-radius:12px;
      border:1px solid var(--border);
    }

    .btn{
      border:1px solid transparent;
      padding:10px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:transform .05s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--btn); color:#fff}
    .btn.secondary{background:var(--btn2); color:var(--text); border-color:var(--border)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .status{
      margin-top:12px; font-weight:700;
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .status.ok{border-color:rgba(22,163,74,.25); color:var(--ok); background:rgba(22,163,74,.06)}
    .status.err{border-color:rgba(220,38,38,.25); color:var(--err); background:rgba(220,38,38,.06)}
    .status.muted{color:var(--muted); background:#fff}

    .panel{
      border:1px solid var(--border);
      border-radius:14px;
      background:linear-gradient(180deg,#0b1023,#0a0f22);
      color:#e5e7eb;
      padding:14px;
      min-height:260px;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13.5px;
      line-height:1.5;
    }
    ul{margin:10px 0 0 0; padding-left:18px}
    li{margin:6px 0}
    a{color:#2563eb; text-decoration:none; font-weight:700}
    a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
  </style>
</head>
<body>

<header>
  <h1>OCR + Keyword Extractor</h1>
  <p class="sub">Group 10</p>
</header>

<div class="container">
  <!-- LEFT -->
  <section class="card">
    <h2>1) Chọn ảnh</h2>
    <div class="row">
      <input type="file" id="fileInput" accept="image/*" />
      <button class="btn primary" id="ocrBtn">OCR</button>
      <button class="btn secondary" id="clearBtn">Clear</button>
    </div>

    <div class="preview" id="preview">
      <div class="muted">Chưa chọn ảnh</div>
    </div>

    <div id="status" class="status muted">Sẵn sàng</div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <h2>2) OCR Text</h2>
    <div id="ocrText" class="panel">(Không có dữ liệu)</div>

    <h2 style="margin-top:14px;">3) Keywords</h2>
    <ul id="keywords"><li class="muted">(Không có dữ liệu)</li></ul>
  </section>
</div>

<script>
  // ⚠️ Vercel là https → EC2 endpoint nên là https để khỏi mixed-content
  const EC2_KEYWORD_API = "https://18.138.11.123.nip.io/keywords";

  const fileInput  = document.getElementById("fileInput");
  const preview    = document.getElementById("preview");
  const ocrBtn     = document.getElementById("ocrBtn");
  const clearBtn   = document.getElementById("clearBtn");
  const statusEl   = document.getElementById("status");
  const ocrTextEl  = document.getElementById("ocrText");
  const keywordsEl = document.getElementById("keywords");

  let imageFile = null;

  function setStatus(type, msg){
    statusEl.className = "status " + (type || "muted");
    statusEl.textContent = msg || "";
  }

  function resetOutputs(){
    ocrTextEl.textContent = "(Không có dữ liệu)";
    keywordsEl.innerHTML = '<li class="muted">(Không có dữ liệu)</li>';
  }

  fileInput.addEventListener("change", () => {
    imageFile = fileInput.files?.[0] || null;
    preview.innerHTML = "";

    if (!imageFile) {
      preview.innerHTML = '<div class="muted">Chưa chọn ảnh</div>';
      setStatus("muted", "Sẵn sàng");
      resetOutputs();
      return;
    }

    const img = document.createElement("img");
    img.src = URL.createObjectURL(imageFile);
    img.onload = () => URL.revokeObjectURL(img.src);
    preview.appendChild(img);

    setStatus("muted", "Đã chọn ảnh. Bấm OCR để chạy.");
    resetOutputs();
  });

  clearBtn.addEventListener("click", () => {
    fileInput.value = "";
    imageFile = null;
    preview.innerHTML = '<div class="muted">Chưa chọn ảnh</div>';
    setStatus("muted", "Sẵn sàng");
    resetOutputs();
  });

  async function runPuterOCR(file) {
    // Puter SDK v2: puter.ai.img2txt(file)
    if (!window.puter?.ai?.img2txt) {
      console.log("puter.ai =", window.puter?.ai);
      throw new Error("Puter SDK chưa có puter.ai.img2txt (xem console)");
    }
    return await puter.ai.img2txt(file);
  }

  function normalizeOCRText(ocrRes){
    let text = "";

    // Một số trường hợp trả string/array/object khác nhau
    if (typeof ocrRes === "string") text = ocrRes;
    else if (Array.isArray(ocrRes)) text = ocrRes.join("\n");
    else if (ocrRes?.text) text = ocrRes.text;
    else if (ocrRes?.data?.text) text = ocrRes.data.text;
    else text = String(ocrRes || "");

    return (text || "").trim();
  }

  function renderKeywordsAsLinks(keywords, googleLinks){
    keywordsEl.innerHTML = "";

    const kws = (keywords || []).filter(Boolean);

    if (!kws.length) {
      keywordsEl.innerHTML = '<li class="muted">(Không có keyword)</li>';
      return;
    }

    kws.forEach((kw, i) => {
      const li = document.createElement("li");
      const a = document.createElement("a");

      // ưu tiên link backend trả về; nếu không có thì tự build link Google
      const href = (googleLinks && googleLinks[i])
        ? googleLinks[i]
        : `https://www.google.com/search?q=${encodeURIComponent(kw)}`;

      a.href = href;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.textContent = kw;

      li.appendChild(a);
      keywordsEl.appendChild(li);
    });
  }

  ocrBtn.addEventListener("click", async () => {
    setStatus("muted", "");
    resetOutputs();

    if (!imageFile) {
      setStatus("err", "❌ Chưa chọn ảnh");
      return;
    }

    ocrBtn.disabled = true;
    setStatus("muted", "⏳ Đang OCR bằng Puter (img2txt)...");

    try {
      const ocrRes = await runPuterOCR(imageFile);
      console.log("OCR raw:", ocrRes);

      const text = normalizeOCRText(ocrRes);
      if (!text) throw new Error("OCR không có nội dung text");

      ocrTextEl.textContent = text;
      setStatus("muted", "⏳ Đang gửi text sang EC2 để lấy keywords...");

      const res = await fetch(EC2_KEYWORD_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, topn: 5 }),
      });

      const raw = await res.text();
      if (!res.ok) throw new Error(`EC2 ${res.status}: ${raw}`);

      const data = JSON.parse(raw);

      renderKeywordsAsLinks(data.keywords || [], data.google_links || []);

      setStatus("ok", "✅ Xong!");
    } catch (e) {
      console.error(e);
      setStatus("err", "❌ Lỗi: " + (e?.message || e));
    } finally {
      ocrBtn.disabled = false;
    }
  });
</script>

</body>
</html>
